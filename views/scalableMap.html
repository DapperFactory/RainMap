<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Google Maps JavaScript API v3 Example: Heatmap Layer</title>
     <script src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=visualization,geometry"></script>
   
   <script>
		      var map, pointarray, heatmap;
      var TILE_SIZE = 256;

      //Mercator --BEGIN--
      function bound(value, opt_min, opt_max) {
          if (opt_min !== null) value = Math.max(value, opt_min);
          if (opt_max !== null) value = Math.min(value, opt_max);
          return value;
      }

      function degreesToRadians(deg) {
          return deg * (Math.PI / 180);
      }

      function radiansToDegrees(rad) {
          return rad / (Math.PI / 180);
      }

      function MercatorProjection() {
          this.pixelOrigin_ = new google.maps.Point(TILE_SIZE / 2,
          TILE_SIZE / 2);
          this.pixelsPerLonDegree_ = TILE_SIZE / 360;
          this.pixelsPerLonRadian_ = TILE_SIZE / (2 * Math.PI);
      }

      MercatorProjection.prototype.fromLatLngToPoint = function (latLng,
      opt_point) {
          var me = this;
          var point = opt_point || new google.maps.Point(0, 0);
          var origin = me.pixelOrigin_;

          point.x = origin.x + latLng.lng() * me.pixelsPerLonDegree_;

          // NOTE(appleton): Truncating to 0.9999 effectively limits latitude to
          // 89.189.  This is about a third of a tile past the edge of the world
          // tile.
          var siny = bound(Math.sin(degreesToRadians(latLng.lat())), - 0.9999,
          0.9999);
          point.y = origin.y + 0.5 * Math.log((1 + siny) / (1 - siny)) * -me.pixelsPerLonRadian_;
          return point;
      };

      MercatorProjection.prototype.fromPointToLatLng = function (point) {
          var me = this;
          var origin = me.pixelOrigin_;
          var lng = (point.x - origin.x) / me.pixelsPerLonDegree_;
          var latRadians = (point.y - origin.y) / -me.pixelsPerLonRadian_;
          var lat = radiansToDegrees(2 * Math.atan(Math.exp(latRadians)) - Math.PI / 2);
          return new google.maps.LatLng(lat, lng);
      };

      //Mercator --END--


      var data_Original = [
          new google.maps.LatLng(-17.3409585, - 63.2597288),
          new google.maps.LatLng(-17.3509585, - 63.2797288),
          new google.maps.LatLng(-17.3609585, - 63.2497288),
      ];

      //NOT USED WEIGHTED POINTS
     var rainDataWeighted = [
        {location: new google.maps.LatLng(23.37815, 72.15321), weight: 10000000},
        {location: new google.maps.LatLng(23.375481, 72.152067), weight: 40000},
        {location: new google.maps.LatLng(23.368648, 72.154466), weight: 3500},
        {location: new google.maps.LatLng(23.364648, 72.164466), weight: 20000}
      ];
      var data = [
          new google.maps.LatLng(23.37815, 72.15321), 
          new google.maps.LatLng(23.375481, 72.152067),
          new google.maps.LatLng(23.368648, 72.154466),
          new google.maps.LatLng(23.364648, 72.164466),
          new google.maps.LatLng(23.364648, 72.164466),
          new google.maps.LatLng(23.364648, 72.164466),  


          new google.maps.LatLng(23.324648, 72.134466),
          new google.maps.LatLng(23.394648, 72.124466),
          new google.maps.LatLng(23.424648, 72.114466),
          new google.maps.LatLng(23.394648, 72.124466),
          new google.maps.LatLng(23.564648, 72.134466),
          new google.maps.LatLng(23.664648, 72.204466),
          new google.maps.LatLng(23.654648, 72.224466),
          new google.maps.LatLng(23.504648, 72.454466),
          new google.maps.LatLng(23.524648, 72.484466),
          new google.maps.LatLng(23.534648, 72.424466),

      ];
	  var desiredRadiusPerPointInMeters = 5000;
      function getNewRadius() {
          
		  
          var numTiles = 1 << map.getZoom();
          var center = map.getCenter();
          var moved = google.maps.geometry.spherical.computeOffset(center, 10000, 90); /*1000 meters to the right*/
          var projection = new MercatorProjection();
          var initCoord = projection.fromLatLngToPoint(center);
          var endCoord = projection.fromLatLngToPoint(moved);
          var initPoint = new google.maps.Point(
            initCoord.x * numTiles,
            initCoord.y * numTiles);
           var endPoint = new google.maps.Point(
            endCoord.x * numTiles,
            endCoord.y * numTiles);
        var pixelsPerMeter = (Math.abs(initPoint.x-endPoint.x))/10000.0;
        var totalPixelSize = Math.floor(desiredRadiusPerPointInMeters*pixelsPerMeter);
        console.log(totalPixelSize);
        return totalPixelSize;
         
      }

      function initialize() {
          var mapOptions = {
              zoom: 10,
              center: new google.maps.LatLng(23.375481, 72.152067),
              mapTypeId: google.maps.MapTypeId.SATELLITE
          };

          map = new google.maps.Map(document.getElementById('map_canvas'),
          mapOptions);

          pointArray = new google.maps.MVCArray(data);

          heatmap = new google.maps.visualization.HeatmapLayer({
              data: pointArray,
			  radius: getNewRadius()
          });

          heatmap.setMap(map);
		  
          google.maps.event.addListener(map, 'zoom_changed', function () {
              heatmap.setOptions({radius:getNewRadius()});
          });
      }

	  var circles = [];
      function circleTest() {
		//yeah, didn't put much effort into this part >_>
		
		 if (circles.length)
		{
			for (i = 0;i < circles.length; ++i)
				circles[i].setMap(null);
			circles = [];
		}	
         else
		 {
			for (i = 0;i < data.length; ++i)
				circles[i] = new google.maps.Circle({
					map:map,
					radius:desiredRadiusPerPointInMeters,
					fillColor:"#000000",
					center: data[i]
				});
		 }
      }

      function toggleHeatmap() {
          heatmap.setMap(heatmap.getMap() ? null : map);
      }
  

function changeGradient() {
  var gradient = [
    'rgba(0, 255, 255, 0)',
    'rgba(0, 255, 255, 1)',
    'rgba(0, 191, 255, 1)',
    'rgba(0, 127, 255, 1)',
    'rgba(0, 63, 255, 1)',
    'rgba(0, 0, 255, 1)',
    'rgba(0, 0, 223, 1)',
    'rgba(0, 0, 191, 1)',
    'rgba(0, 0, 159, 1)',
    'rgba(0, 0, 127, 1)',
    'rgba(63, 0, 91, 1)',
    'rgba(127, 0, 63, 1)',
    'rgba(191, 0, 31, 1)',
    'rgba(255, 0, 0, 1)'
  ]
  heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
}

function changeRadius() {
  heatmap.set('radius', heatmap.get('radius') ? null : 50);
}

function changeOpacity() {
  heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
}

var marker = new google.maps.Marker({
    position: new google.maps.LatLng(23.375481, 72.152067),
    title: "center",
    map: map,
});
  function centerMap(){
    //heatmap.setCenter(marker.getPosition());
    console.log("Center On Map was clicked");
    heatmap.setCenter(new google.maps.LatLng(23.375481, 72.152067));
  }

google.maps.event.addDomListener(window, 'load', initialize);


	 </script>
   </head>

  <body onload="initialize()">
     <div id="panel">
      <button onclick="toggleHeatmap()">Toggle Heatmap</button>
      <button onclick="changeGradient()">Change gradient</button>
      <button onclick="changeRadius()">Change radius</button>
      <button onclick="changeOpacity()">Change opacity</button>
      <button onclick="centerMap()">Center On Points</button>
    </div>

    <div id="map_canvas" style="height: 600px; width: 800px;"></div>
    <button onclick="circleTest()">Test With Circles</button>
   
    
  </body>
</html>